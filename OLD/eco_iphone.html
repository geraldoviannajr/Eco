
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Eco Maze iPhone</title>
  <style>
    body { margin: 0; background: black; overflow: hidden; }
    canvas { display: block; }
    #cooldown { position: absolute; top: 5%; left: 5%; color: white; font-family: sans-serif; z-index:10; }
  </style>
</head>
<body>
<div id="cooldown">Pronto</div>
<canvas id="gameCanvas"></canvas>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
// iPhone 12 landscape logical resolution ~844x390; use full window
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

const TILE_SIZE = canvas.height / 15; // 15 rows
const ROWS = 15;
const COLS = Math.floor(canvas.width / TILE_SIZE);

const map = [
  // Widened corridor sections (zeros)
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,1,1,1,1,1,1],
  [1,0,1,1,0,1,0,1,1,1,0,1,1,0,1],
  [1,0,1,0,0,1,0,0,0,1,0,0,1,0,1],
  [1,0,1,0,1,1,1,0,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
  [1,1,1,1,1,0,1,1,1,0,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,0,0,1,0,1],
  [1,0,1,0,1,1,1,1,1,1,1,0,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,1,0,1,0,1],
  [1,0,1,1,1,1,1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
];

// Door position at map[12][13]
const DOOR = {row:12, col:13, revealed: false, expire:0};

let player = { x:TILE_SIZE*1.5, y:TILE_SIZE*1.5, radius:6, speed:2 };
let rays = [], keys={};
let lastStepTime=0, stepInterval=200, lastMovementTime=0, isMoving=false;
let lastClapTime=0, clapCooldown=5000;

const stepSound=new Audio('step1.mp3'), clapSound=new Audio('clap1.mp3');
stepSound.volume=0.3; clapSound.volume=0.5;
const cooldownText=document.getElementById('cooldown');

class Ray {
  constructor(x,y,angle,intensity,life=100,bounces=5){
    this.x=x;this.y=y;this.dx=Math.cos(angle);this.dy=Math.sin(angle);
    this.intensity=intensity;this.life=life;this.bounces=bounces;this.path=[{x,y}];
  }
  update(){
    if(this.life<=0||this.intensity<0.01) return false;
    const step=2;
    const nx=this.x+this.dx*step, ny=this.y+this.dy*step;
    const tx=Math.floor(nx/TILE_SIZE), ty=Math.floor(ny/TILE_SIZE);
    if(tx<0||ty<0||tx>=COLS||ty>=ROWS){ this.life=0; return false; }
    if(map[ty][tx]===1){
      const bx=map[Math.floor(this.y/TILE_SIZE)][Math.floor((this.x+this.dx*step)/TILE_SIZE)]===1;
      const by=map[Math.floor((this.y+this.dy*step)/TILE_SIZE)][Math.floor(this.x/TILE_SIZE)]===1;
      if(bx) this.dx*=-1; if(by) this.dy*=-1;
      if(!bx&&!by){ this.dx*=-1;this.dy*=-1; }
      this.intensity*=0.75; this.bounces--;
    } else { this.x=nx; this.y=ny; }
    this.path.push({x:this.x,y:this.y});
    this.life--; this.intensity*=0.985;
    // reveal door if hit
    if(tx===DOOR.col && ty===DOOR.row){
      DOOR.revealed=true; DOOR.expire=performance.now()+3000;
    }
    return true;
  }
  draw(){
    if(this.path.length<2) return;
    ctx.strokeStyle=`rgba(0,255,255,${this.intensity})`;
    ctx.lineWidth=1; ctx.beginPath();
    ctx.moveTo(this.path[0].x,this.path[0].y);
    this.path.forEach(p=>ctx.lineTo(p.x,p.y)); ctx.stroke();
  }
}

function triggerStepEcho(){
  const now=performance.now();
  if(now-lastStepTime<stepInterval) return;
  lastStepTime=now;
  for(let i=0;i<60;i++) rays.push(new Ray(player.x,player.y,(2*Math.PI/60)*i,0.3,100));
  stepSound.currentTime=0; stepSound.play();
}

function triggerClapEcho(){
  const now=performance.now();
  if(now-lastClapTime<clapCooldown) return;
  lastClapTime=now; cooldownText.textContent='Recarregando...';
  setTimeout(()=>cooldownText.textContent='Pronto',clapCooldown);
  for(let i=0;i<120;i++) rays.push(new Ray(player.x,player.y,(2*Math.PI/120)*i,1,200));
  clapSound.currentTime=0; clapSound.play();
}

function isWalkable(x,y){
  const pad=player.radius-1;
  const l=Math.floor((x-pad)/TILE_SIZE), r=Math.floor((x+pad)/TILE_SIZE);
  const t=Math.floor((y-pad)/TILE_SIZE), b=Math.floor((y+pad)/TILE_SIZE);
  return map[t]?.[l]===0&&map[t]?.[r]===0&&map[b]?.[l]===0&&map[b]?.[r]===0;
}

function movePlayer(){
  let moved=false;
  if(keys['w']){const ny=player.y-player.speed;if(isWalkable(player.x,ny)) player.y=ny; moved=true;}
  if(keys['s']){const ny=player.y+player.speed;if(isWalkable(player.x,ny)) player.y=ny; moved=true;}
  if(keys['a']){const nx=player.x-player.speed;if(isWalkable(nx,player.y)) player.x=nx; moved=true;}
  if(keys['d']){const nx=player.x+player.speed;if(isWalkable(nx,player.y)) player.x=nx; moved=true;}
  if(moved){ triggerStepEcho(); isMoving=true; lastMovementTime=performance.now(); }
  else { isMoving=false; }
}

function update(){
  movePlayer();
  const now=performance.now();
  if(!isMoving && now-lastMovementTime>200){ stepSound.pause(); stepSound.currentTime=0; }
  rays=rays.filter(r=>r.update());
  // door visibility expire
  if(DOOR.revealed && performance.now()>DOOR.expire){ DOOR.revealed=false; }
}

function draw(){
  ctx.fillStyle='black'; ctx.fillRect(0,0,canvas.width,canvas.height);
  rays.forEach(r=>r.draw());
  // draw door if revealed
  if(DOOR.revealed){
    ctx.fillStyle='orange'; 
    ctx.fillRect(DOOR.col*TILE_SIZE, DOOR.row*TILE_SIZE, TILE_SIZE, TILE_SIZE);
  }
}

function gameLoop(){ update(); draw(); requestAnimationFrame(gameLoop); }

document.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; if(e.code==='Space') triggerClapEcho(); });
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

gameLoop();
</script>
</body>
</html>
